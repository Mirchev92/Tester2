{% extends "Customer_User/Customer_base.html" %}

{% block content %}
<div class="my-cases-container">
    <div class="section-header">
        <h2>My Cases</h2>
        <a href="{{ url_for('customer_create_case') }}" class="create-case-btn">
            <i class="fas fa-plus"></i> New Case
        </a>
    </div>

    <div class="cases-filter">
        <select id="statusFilter" class="filter-select">
            <option value="all">All Cases</option>
            <option value="pending">Pending</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
        </select>
    </div>

    <div class="cases-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        {% for case in cases %}
        <div class="case-card" data-case-id="{{ case.id }}" data-status="{{ case.status }}" style="display: flex; flex-direction: column; justify-content: space-between; padding: 20px; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
            <div class="case-header">
                <h3>{{ case.title }}</h3>
                <span class="case-status {{ case.status }}">{{ case.status.replace('_', ' ').title() }}</span>
            </div>
            <div class="case-content">
                <p class="case-description">{{ case.description[:150] }}{% if case.description|length > 150 %}...{% endif %}</p>
                <div class="case-details">
                    <p><i class="fas fa-calendar"></i> Created: {{ case.created_at.strftime('%Y-%m-%d') }}</p>
                    <p><i class="fas fa-dollar-sign"></i> Budget: ${{ case.budget }}</p>
                    <p><i class="fas fa-map-marker-alt"></i> {{ case.location }}</p>
                    {% if case.specialist %}
                    <p><i class="fas fa-user-cog"></i> Specialist: {{ case.specialist.username }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="case-actions">
                <button class="view-details-btn" data-case-id="{{ case.id }}">View Details</button>
                {% if case.status != 'completed' %}
                    <button class="close-case-btn" onclick="closeCase('{{ case.id }}')">Close Case</button>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="no-cases">
            <i class="fas fa-folder-open"></i>
            <p>No cases found. Create your first case!</p>
            <a href="{{ url_for('customer_create_case') }}" class="create-case-btn">Create Case</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Case Details Modal -->
<div id="caseModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function closeCase(caseId) {
    if (!caseId || caseId === 'null') return; // Prevent null case ID
    
    if (!confirm('Are you sure you want to close this case?')) {
        return;
    }

    try {
        const response = await fetch(`/customer/api/case/${caseId}/close`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Instead of reloading, update the UI directly
            const caseCard = document.querySelector(`[data-case-id="${caseId}"]`);
            if (caseCard) {
                const statusElement = caseCard.querySelector('.case-status');
                if (statusElement) {
                    statusElement.textContent = 'Completed';
                    statusElement.className = 'case-status completed';
                }
                // Remove the close button
                const closeButton = caseCard.querySelector('.close-case-btn');
                if (closeButton) {
                    closeButton.remove();
                }
            }
        } else {
            const error = await response.json();
            alert(error.message || 'Failed to close case');
        }
    } catch (error) {
        console.error('Error closing case:', error);
        alert('An error occurred while closing the case');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Status filter handler
    document.getElementById('statusFilter').addEventListener('change', function() {
        const status = this.value;
        const cards = document.querySelectorAll('.case-card');
        
        cards.forEach(card => {
            if (status === 'all' || card.dataset.status === status) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    });

    // Modal handlers
    const modal = document.getElementById('caseModal');
    const modalContent = document.getElementById('modalContent');
    const closeBtn = document.querySelector('.close');

    // View details button handler
    document.querySelectorAll('.view-details-btn').forEach(button => {
        button.addEventListener('click', function() {
            const caseId = this.getAttribute('data-case-id');
            modal.style.display = 'block';
            modalContent.innerHTML = `Loading details for case ${caseId}`;
        });
    });

    // Close button handler
    closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    // Click outside modal handler
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
});
</script>
{% endblock %}