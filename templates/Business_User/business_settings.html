{% extends "Business_User/business_base.html" %}
{% block content %}

<div class="settings-container">
    <div class="section-header">
        <h1>Business Settings</h1>
    </div>

    <form method="POST" enctype="multipart/form-data" class="settings-form">
        <!-- Profile Card -->
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-picture-section">
                    <div class="current-picture">
                        {% if current_user.profile_picture %}
                        <img src="{{ url_for('static', filename='uploads/' + current_user.profile_picture) }}" 
                             class="profile-image" 
                             alt="Profile Picture">
                    {% endif %}
                    </div>
                    <div class="profile-upload">
                        <label for="profile_picture" class="upload-btn">
                            <i class="fas fa-camera"></i>
                            Change Photo
                        </label>
                        <input type="file" 
                               id="profile_picture" 
                               name="profile_picture" 
                               accept="image/*" 
                               hidden>
                    </div>
                </div>
            </div>
        </div>

        <!-- Professional Info Card -->
        <div class="settings-card">
            <h2>Professional Information</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" 
                           name="name" 
                           value="{{ current_user.name or '' }}" 
                           class="form-control" 
                           placeholder="Your full name">
                </div>

                <div class="form-group">
                    <label>Specialization</label>
                    <select name="specialization" class="form-control">
                        <option value="">Select Specialization</option>
                        <option value="Electrician" {% if current_user.specialization == 'Electrician' %}selected{% endif %}>Electrician</option>
                        <option value="Plumber" {% if current_user.specialization == 'Plumber' %}selected{% endif %}>Plumber</option>
                        <option value="Carpenter" {% if current_user.specialization == 'Carpenter' %}selected{% endif %}>Carpenter</option>
                        <option value="HVAC" {% if current_user.specialization == 'HVAC' %}selected{% endif %}>HVAC</option>
                        <option value="Painter" {% if current_user.specialization == 'Painter' %}selected{% endif %}>Painter</option>
                        <option value="General Contractor" {% if current_user.specialization == 'General Contractor' %}selected{% endif %}>General Contractor</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Years of Experience</label>
                    <input type="number" 
                           name="years_experience" 
                           value="{{ current_user.years_experience or '' }}" 
                           class="form-control" 
                           min="0">
                </div>
            </div>

            <div class="form-group">
                <label>Professional Bio</label>
                <textarea name="bio" 
                          rows="4" 
                          class="form-control" 
                          placeholder="Tell potential clients about yourself and your expertise...">{{ current_user.bio or '' }}</textarea>
            </div>
        </div>

        <!-- Work Gallery Card -->
        <div class="settings-card">
            <h2>Work Gallery</h2>
            <div class="gallery-upload-section">
                <label for="gallery_images" class="gallery-upload-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    Add Work Photos
                </label>
                <input type="file" 
                       id="gallery_images" 
                       name="gallery_images[]" 
                       multiple 
                       accept="image/*" 
                       hidden>
                {% if current_user.business_profile.tier.name == 'Basic' %}
                    {% set current_count = gallery_items|length %}
                    {% set remaining = 5 - current_count %}
                    <p class="upload-hint">Basic tier: {{ current_count }}/5 images used. You can upload {{ remaining }} more image{{ 's' if remaining != 1 else '' }}. Maximum 5MB per image.</p>
                {% else %}
                    <p class="upload-hint">You can select multiple images. Maximum 5MB per image.</p>
                {% endif %}
            </div>

            <div class="gallery-grid">
                {% for item in gallery_items %}
                <div class="gallery-item" data-id="{{ item.id }}">
                    <img src="{{ url_for('static', filename='uploads/' + item.image_path) }}" 
                         alt="Gallery Image">
                    <div class="gallery-item-overlay">
                        <textarea name="gallery_descriptions[]" 
                                  placeholder="Describe this work...">{{ item.description or '' }}</textarea>
                        <button type="button" class="delete-gallery-btn" data-id="{{ item.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <!-- Business Details Card -->
        <div class="settings-card">
            <h2>Business Details</h2>
            
            <div class="form-group">
                <label>Service Location</label>
                <input type="text" 
                       name="location" 
                       value="{{ current_user.location or '' }}" 
                       class="form-control" 
                       placeholder="City, State or Region">
            </div>

            <div class="working-hours-section">
                <h3>Working Hours</h3>
                <div class="time-inputs">
                    <div class="time-group">
                        <label>Start Time</label>
                        <input type="time" 
                               name="working_hours_start" 
                               value="{{ current_user.working_hours_start }}">
                    </div>
                    <div class="time-group">
                        <label>End Time</label>
                        <input type="time" 
                               name="working_hours_end" 
                               value="{{ current_user.working_hours_end }}">
                    </div>
                </div>

                <div class="working-days">
                    <h3>Working Days</h3>
                    <div class="days-grid">
                        {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                        <div class="day-toggle">
                            <input type="checkbox" 
                                   id="day_{{ day }}" 
                                   name="working_days" 
                                   value="{{ day }}"
                                   {% if day in current_user.working_days.split(',') %}checked{% endif %}>
                            <label for="day_{{ day }}">{{ day[:3] }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Card -->
        <div class="settings-card">
            <h2>Contact Information</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" 
                           name="phone_number" 
                           value="{{ current_user.phone_number }}" 
                           class="form-control">
                </div>

                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" 
                           name="email" 
                           value="{{ current_user.email or '' }}" 
                           class="form-control">
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="save-settings-btn">
                <i class="fas fa-save"></i>
                Save All Changes
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Profile picture preview
    const profileInput = document.getElementById('profile_picture');
    if (profileInput) {
        profileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.querySelector('.current-picture img') || document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'profile-image';
                    if (!document.querySelector('.current-picture img')) {
                        document.querySelector('.current-picture').innerHTML = '';
                        document.querySelector('.current-picture').appendChild(img);
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Gallery image preview
    const galleryInput = document.getElementById('gallery_images');
    if (galleryInput) {
        galleryInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const gallery = document.querySelector('.gallery-grid');
            
            files.forEach(file => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'gallery-item preview';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <div class="gallery-item-overlay">
                                <textarea name="gallery_descriptions[]" placeholder="Describe this work..."></textarea>
                            </div>
                        `;
                        gallery.insertBefore(previewDiv, gallery.firstChild);
                    }
                    reader.readAsDataURL(file);
                }
            });
        });
    }

    // Delete gallery item
    document.querySelectorAll('.delete-gallery-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.dataset.id;
            if (confirm('Are you sure you want to delete this image?')) {
                fetch(`/business/gallery/delete/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.closest('.gallery-item').remove();
                    } else {
                        alert('Error deleting image');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting image');
                });
            }
        });
    });
});
</script>
{% endblock %}