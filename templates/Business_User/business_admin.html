{% extends "business_user/business_base.html" %}

{% block title %}Admin Dashboard - MissCall App{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1>Admin Dashboard</h1>
        <div class="header-actions">
            <span class="last-updated">Last updated: <time id="update-time">Just now</time></span>
            <button onclick="refreshDashboard()" class="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-details">
                <h3>Users Overview</h3>
                <div class="stat-numbers">
                    <div class="stat-item">
                        <span class="stat-label">Total</span>
                        <span class="stat-value" id="total-users">Loading...</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active</span>
                        <span class="stat-value" id="active-users">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-comment-alt"></i>
            </div>
            <div class="stat-details">
                <h3>SMS Activity</h3>
                <div class="stat-numbers">
                    <div class="stat-item">
                        <span class="stat-label">Total Calls</span>
                        <span class="stat-value" id="total-calls">Loading...</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">SMS Sent</span>
                        <span class="stat-value" id="total-sms">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-server"></i>
            </div>
            <div class="stat-details">
                <h3>System Health</h3>
                <div class="stat-numbers">
                    <div class="stat-item">
                        <span class="stat-label">CPU</span>
                        <span class="stat-value" id="cpu-usage">Loading...</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Memory</span>
                        <span class="stat-value" id="memory-usage">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="admin-section">
        <div class="section-header">
            <h2><i class="fas fa-users"></i> User Management</h2>
            <select id="user-select" class="user-select" onchange="filterUsers(this.value)">
                <option value="">Select User</option>
                {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>User Type</th>
                        <th>Phone Number</th>
                        <th>SMS Status</th>
                        <th>Admin Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <div class="user-info" data-user-id="{{ user.id }}">
                                <span class="user-avatar">{{ user.username[0] | upper }}</span>
                                <span class="user-name">{{ user.username }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="user-type-badge {{ user.user_type }}">
                                {{ user.user_type | title }}
                            </span>
                        </td>
                        <td>{{ user.phone_number }}</td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       {% if user.sms_enabled %}checked{% endif %}
                                       onchange="updateUserSetting('{{ user.id }}', 'sms_enabled', this.checked)"
                                       {% if user.id == current_user.id %}disabled{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox" 
                                       {% if user.is_admin %}checked{% endif %}
                                       onchange="updateUserSetting('{{ user.id }}', 'is_admin', this.checked)"
                                       {% if user.id == current_user.id %}disabled{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                        <td class="actions-cell">
                            <button onclick="resetUserPassword('{{ user.id }}')" 
                                    class="action-btn"
                                    {% if user.id == current_user.id %}disabled{% endif %}
                                    title="Reset Password">
                                <i class="fas fa-key"></i>
                            </button>
                            <button onclick="deleteUser('{{ user.id }}')" 
                                    class="action-btn danger"
                                    {% if user.id == current_user.id %}disabled{% endif %}
                                    title="Delete User">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Activity Log Section -->
    <div class="admin-section">
        <div class="section-header">
            <h2><i class="fas fa-history"></i> Activity Log</h2>
            <select id="selected-user" onchange="updateActivityLog()" class="user-select">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="activity-log">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Action</th>
                        <th>Time</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="activity-log">
                    <!-- Populated via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- SMS Template Management -->
    <div class="admin-section">
        <div class="section-header">
            <h2><i class="fas fa-envelope"></i> SMS Templates</h2>
            <select id="template-user-select" class="user-select">
                <option value="">Select User</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="template-editor">
            <div class="template-grid">
                <div class="template-card">
                    <h3>Default Template</h3>
                    <textarea id="default-template" rows="3" 
                              placeholder="Enter default message template..."></textarea>
                </div>
                <div class="template-card">
                    <h3>Off Hours Message</h3>
                    <textarea id="off-hours-template" rows="3"
                              placeholder="Enter off-hours message..."></textarea>
                </div>
                <div class="template-card">
                    <h3>Vacation Message</h3>
                    <textarea id="vacation-template" rows="3"
                              placeholder="Enter vacation message..."></textarea>
                </div>
            </div>
            <div class="template-actions">
                <button onclick="saveTemplates()" class="save-templates-btn">
                    <i class="fas fa-save"></i> Save Templates
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function updateUserSetting(userId, setting, value) {
        fetch('/api/admin/update-user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                setting: setting,
                value: value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User updated successfully');
            } else {
                alert(data.error);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
            location.reload();
        });
    }

    function resetUserPassword(userId) {
        if (!confirm('Are you sure you want to reset this user\'s password?')) return;
        
        fetch('/api/admin/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`New password: ${data.new_password}`);
            } else {
                alert(data.error);
            }
        });
    }

    function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user?')) return;
        
        fetch('/api/admin/delete-user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error);
            }
        });
    }

    function loadStatistics() {
        fetch('/api/admin/statistics')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-users').textContent = data.total_users;
                document.getElementById('active-users').textContent = data.users_by_status.active;
                document.getElementById('inactive-users').textContent = data.users_by_status.inactive;
                document.getElementById('total-calls').textContent = data.total_calls;
                document.getElementById('total-sms').textContent = data.total_sms_sent;
            });
    }

    function loadSystemHealth() {
        fetch('/api/admin/system-health')
            .then(response => response.json())
            .then(data => {
                document.getElementById('cpu-usage').textContent = `${data.system_load.cpu}%`;
                document.getElementById('memory-usage').textContent = `${data.system_load.memory}%`;
                document.getElementById('sms-status').textContent = data.sms_service_status ? 'Online' : 'Offline';
            });
    }

    function loadUserActivity(userId) {
        if (!userId) return;
        fetch(`/api/admin/user-activity/${userId}`)
            .then(response => response.json())
            .then(data => {
                const log = document.getElementById('activity-log');
                log.innerHTML = data.map(activity => `
                    <div class="activity-item">
                        <span class="activity-time">${new Date(activity.timestamp).toLocaleString()}</span>
                        <span class="activity-action">${activity.action}</span>
                        <span class="activity-details">${activity.details}</span>
                    </div>
                `).join('');
            });
    }

    function saveTemplates() {
        const userId = document.getElementById('template-user-select').value;
        if (!userId) {
            alert('Please select a user');
            return;
        }

        fetch('/api/admin/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                template: document.getElementById('default-template').value,
                off_hours_message: document.getElementById('off-hours-template').value,
                vacation_message: document.getElementById('vacation-template').value
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Templates saved successfully');
            } else {
                alert('Error saving templates');
            }
        });
    }

    function updateActivityLog() {
        const userId = document.getElementById('selected-user').value;
        
        fetch(`/api/admin/user-activity/${userId}`)
            .then(response => response.json())
            .then(activities => {
                const logTable = document.getElementById('activity-log');
                logTable.innerHTML = activities.map(activity => `
                    <tr>
                        <td>${activity.username}</td>
                        <td>${activity.action}</td>
                        <td>${activity.timestamp}</td>
                        <td>${activity.details}</td>
                    </tr>
                `).join('');
            });
    }

    function filterUsers(userId) {
        // Get all table rows
        const rows = document.querySelectorAll('.admin-table tbody tr');
        
        if (!userId) {
            // If no user selected (i.e., "Select User" option), show all rows
            rows.forEach(row => {
                row.style.display = '';
            });
            return;
        }
        
        // Hide all rows first
        rows.forEach(row => {
            const rowUserId = row.querySelector('.user-info').getAttribute('data-user-id');
            if (rowUserId === userId) {
                row.style.display = ''; // Show matching row
            } else {
                row.style.display = 'none'; // Hide non-matching rows
            }
        });
    }

    // Load initial data
    loadStatistics();
    loadSystemHealth();

    // Refresh data periodically
    setInterval(loadStatistics, 300000); // every 5 minutes
    setInterval(loadSystemHealth, 60000); // every minute

    // Update every 30 seconds
    setInterval(updateActivityLog, 30000);
    // Initial load
    updateActivityLog();
</script>
{% endblock %}