<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MissCall App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="dashboard-layout">
        <!-- Reuse the same sidebar structure -->
        <div class="sidebar">
            <div class="sidebar-content">
                <a href="{{ url_for('dashboard') }}" class="sidebar-item">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </a>
                {% if current_user.is_admin %}
                <a href="{{ url_for('admin_dashboard') }}" class="sidebar-item">
                    <i class="fas fa-user-shield"></i>
                    Admin Panel
                </a>
                {% endif %}
                <!-- ... other sidebar items ... -->
            </div>
        </div>

        <div class="main-content">
            <header class="dashboard-header">
                <h1>Admin Dashboard</h1>
                <div class="user-actions">
                    <span>{{ current_user.username }} (Admin)</span>
                    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                </div>
            </header>

            <div class="admin-section">
                <h2>User Management</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Phone Number</th>
                                <th>SMS Enabled</th>
                                <th>Admin Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>{{ user.phone_number }}</td>
                                <td>
                                    <input type="checkbox" 
                                           {% if user.sms_enabled %}checked{% endif %}
                                           onchange="updateUserSetting('{{ user.id }}', 'sms_enabled', this.checked)"
                                           {% if user.id == current_user.id %}disabled{% endif %}>
                                </td>
                                <td>
                                    <input type="checkbox" 
                                           {% if user.is_admin %}checked{% endif %}
                                           onchange="updateUserSetting('{{ user.id }}', 'is_admin', this.checked)"
                                           {% if user.id == current_user.id %}disabled{% endif %}>
                                </td>
                                <td>
                                    <button onclick="resetUserPassword('{{ user.id }}')" 
                                            class="action-btn"
                                            {% if user.id == current_user.id %}disabled{% endif %}>
                                        Reset Password
                                    </button>
                                    <button onclick="deleteUser('{{ user.id }}')" 
                                            class="action-btn danger"
                                            {% if user.id == current_user.id %}disabled{% endif %}>
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-section">
                <h2>System Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Users</h3>
                        <div class="stat-content">
                            <p>Total: <span id="total-users">Loading...</span></p>
                            <p>Active: <span id="active-users">Loading...</span></p>
                            <p>Inactive: <span id="inactive-users">Loading...</span></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>SMS Statistics</h3>
                        <div class="stat-content">
                            <p>Total Calls: <span id="total-calls">Loading...</span></p>
                            <p>SMS Sent: <span id="total-sms">Loading...</span></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>System Health</h3>
                        <div class="stat-content">
                            <p>CPU Usage: <span id="cpu-usage">Loading...</span></p>
                            <p>Memory Usage: <span id="memory-usage">Loading...</span></p>
                            <p>SMS Service: <span id="sms-status">Loading...</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h2>User Activity Log</h2>
                <select id="selected-user" onchange="updateActivityLog()">
                    <option value="">Select User</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
                <div class="activity-log-section">
                    <h3>User Activity Log</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Action</th>
                                <th>Time</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="activity-log">
                            <!-- Will be populated via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-section">
                <h2>SMS Template Management</h2>
                <select id="template-user-select">
                    <option value="">Select User</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
                <div class="template-editor">
                    <div class="template-group">
                        <label>Default Template</label>
                        <textarea id="default-template" rows="3"></textarea>
                    </div>
                    <div class="template-group">
                        <label>Off Hours Message</label>
                        <textarea id="off-hours-template" rows="3"></textarea>
                    </div>
                    <div class="template-group">
                        <label>Vacation Message</label>
                        <textarea id="vacation-template" rows="3"></textarea>
                    </div>
                    <button onclick="saveTemplates()">Save Templates</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateUserSetting(userId, setting, value) {
            fetch('/api/admin/update-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    setting: setting,
                    value: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User updated successfully');
                } else {
                    alert(data.error);
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred');
                location.reload();
            });
        }

        function resetUserPassword(userId) {
            if (!confirm('Are you sure you want to reset this user\'s password?')) return;
            
            fetch('/api/admin/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`New password: ${data.new_password}`);
                } else {
                    alert(data.error);
                }
            });
        }

        function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            fetch('/api/admin/delete-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error);
                }
            });
        }

        function loadStatistics() {
            fetch('/api/admin/statistics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-users').textContent = data.total_users;
                    document.getElementById('active-users').textContent = data.users_by_status.active;
                    document.getElementById('inactive-users').textContent = data.users_by_status.inactive;
                    document.getElementById('total-calls').textContent = data.total_calls;
                    document.getElementById('total-sms').textContent = data.total_sms_sent;
                });
        }

        function loadSystemHealth() {
            fetch('/api/admin/system-health')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cpu-usage').textContent = `${data.system_load.cpu}%`;
                    document.getElementById('memory-usage').textContent = `${data.system_load.memory}%`;
                    document.getElementById('sms-status').textContent = data.sms_service_status ? 'Online' : 'Offline';
                });
        }

        function loadUserActivity(userId) {
            if (!userId) return;
            fetch(`/api/admin/user-activity/${userId}`)
                .then(response => response.json())
                .then(data => {
                    const log = document.getElementById('activity-log');
                    log.innerHTML = data.map(activity => `
                        <div class="activity-item">
                            <span class="activity-time">${new Date(activity.timestamp).toLocaleString()}</span>
                            <span class="activity-action">${activity.action}</span>
                            <span class="activity-details">${activity.details}</span>
                        </div>
                    `).join('');
                });
        }

        function saveTemplates() {
            const userId = document.getElementById('template-user-select').value;
            if (!userId) {
                alert('Please select a user');
                return;
            }

            fetch('/api/admin/templates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    template: document.getElementById('default-template').value,
                    off_hours_message: document.getElementById('off-hours-template').value,
                    vacation_message: document.getElementById('vacation-template').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Templates saved successfully');
                } else {
                    alert('Error saving templates');
                }
            });
        }

        function updateActivityLog() {
            const userId = document.getElementById('selected-user').value;
            
            fetch(`/api/admin/user-activity/${userId}`)
                .then(response => response.json())
                .then(activities => {
                    const logTable = document.getElementById('activity-log');
                    logTable.innerHTML = activities.map(activity => `
                        <tr>
                            <td>${activity.username}</td>
                            <td>${activity.action}</td>
                            <td>${activity.timestamp}</td>
                            <td>${activity.details}</td>
                        </tr>
                    `).join('');
                });
        }

        // Load initial data
        loadStatistics();
        loadSystemHealth();

        // Refresh data periodically
        setInterval(loadStatistics, 300000); // every 5 minutes
        setInterval(loadSystemHealth, 60000); // every minute

        // Update every 30 seconds
        setInterval(updateActivityLog, 30000);
        // Initial load
        updateActivityLog();
    </script>
</body>
</html> 